---
# ansible/test_service_account_setup.yml
# Test the enhanced OpenShift service account setup for AAP

- name: Test Enhanced OpenShift Service Account Setup for AAP
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # Force credential update for testing
    force_credential_update: true

  tasks:
    - name: Display test information
      debug:
        msg: |
          ğŸ§ª Testing Enhanced AAP Configuration with Service Account Management
          
          ğŸ“‹ Test Objectives:
          1. Create/verify OpenShift service account (servicenow-aap-sa)
          2. Generate long-lived token for the service account
          3. Test token validity
          4. Update AAP credentials with service account token
          5. Verify AAP can use the new credentials
          
          ğŸ”§ Configuration:
          - OpenShift API: {{ openshift_api_url }}
          - AAP Controller: {{ aap_url }}
          - Force Update: {{ force_credential_update }}

    - name: Include enhanced AAP configuration role
      include_role:
        name: aap_configuration

    - name: Test the updated AAP job template with service account token
      uri:
        url: "{{ aap_url }}/api/v2/job_templates/9/launch/"
        method: POST
        headers:
          Authorization: "Bearer {{ vault_aap_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          extra_vars:
            project_name: "test-service-account-{{ ansible_date_time.epoch }}"
            display_name: "Test Service Account Integration"
            environment: "development"
            requestor: "service-account-test"
            servicenow_request_number: "REQ-SA-TEST"
        validate_certs: false
        status_code: 201
      register: test_job_launch
      ignore_errors: true

    - name: Display test job launch results
      debug:
        msg: |
          ğŸš€ AAP Job Template Test Results:
          
          {% if test_job_launch.status == 201 %}
          âœ… Job Launch: Successful
          - Job ID: {{ test_job_launch.json.id }}
          - Job URL: {{ aap_url }}/#/jobs/playbook/{{ test_job_launch.json.id }}
          - Status: {{ test_job_launch.json.status }}
          {% else %}
          âŒ Job Launch: Failed
          - Status Code: {{ test_job_launch.status | default('N/A') }}
          - Error: {{ test_job_launch.msg | default('Unknown error') }}
          {% endif %}

    - name: Wait for job completion (if launched successfully)
      uri:
        url: "{{ aap_url }}/api/v2/jobs/{{ test_job_launch.json.id }}/"
        method: GET
        headers:
          Authorization: "Bearer {{ vault_aap_token }}"
        validate_certs: false
      register: job_status
      until: job_status.json.status in ['successful', 'failed', 'error', 'canceled']
      retries: 30
      delay: 10
      when: test_job_launch.status == 201

    - name: Verify OpenShift project creation
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "test-service-account-{{ ansible_date_time.epoch }}"
        host: "{{ openshift_api_url }}"
        api_key: "{{ bearer_token }}"
        validate_certs: false
      register: created_project
      when: test_job_launch.status == 201 and job_status.json.status == 'successful'

    - name: Display final test results
      debug:
        msg: |
          ğŸ¯ Enhanced Service Account Setup Test Results:
          
          ğŸ“Š Overall Status: {{ 'SUCCESS' if test_job_launch.status == 201 and job_status.json.status == 'successful' else 'PARTIAL/FAILED' }}
          
          ğŸ”§ Service Account Setup:
          âœ… Service Account: servicenow-aap-sa created/verified
          âœ… Token Generation: Long-lived token created
          âœ… AAP Credential: Updated with service account token
          
          ğŸš€ AAP Integration Test:
          {% if test_job_launch.status == 201 %}
          âœ… Job Launch: Successful (Job {{ test_job_launch.json.id }})
          âœ… Job Execution: {{ job_status.json.status | upper if job_status is defined else 'IN PROGRESS' }}
          {% if job_status is defined and job_status.json.status == 'successful' %}
          âœ… OpenShift Project: {{ 'Created' if created_project.resources | length > 0 else 'Not Found' }}
          {% endif %}
          {% else %}
          âŒ Job Launch: Failed
          {% endif %}
          
          ğŸ’¡ Benefits of Service Account Approach:
          - âœ… No token expiration issues
          - âœ… Dedicated service identity
          - âœ… Consistent authentication
          - âœ… Automated token management
          
          ğŸ”— Next Steps:
          {% if test_job_launch.status == 201 and job_status.json.status == 'successful' %}
          - Service account setup is working perfectly
          - AAP can now reliably create OpenShift projects
          - No more token expiration issues
          {% else %}
          - Check AAP job logs for any remaining issues
          - Verify service account permissions
          - Test manual project creation with service account token
          {% endif %}
