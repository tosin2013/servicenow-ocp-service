---
- name: Pre-flight Checks for ServiceNow OCP Integration
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - vars/production.yml

  tasks:
    - name: 1. Verify OpenShift Cluster Connection
      block:
        - name: Attempt to connect to OpenShift cluster and get nodes
          kubernetes.core.k8s_info:
            api_version: v1
            kind: Node
          register: openshift_connection_test
          no_log: true

        - name: Display OpenShift connection status
          ansible.builtin.debug:
            msg: "✅ SUCCESS: Successfully connected to OpenShift cluster '{{ openshift_connection_test.api_endpoint }}'. Found {{ openshift_connection_test.resources | length }} nodes."
      rescue:
        - name: Display OpenShift connection failure
          ansible.builtin.fail:
            msg: "❌ FAILURE: Could not connect to the OpenShift cluster. Please check your kubeconfig or authentication token."

    - name: 2. Verify Keycloak (RH-SSO) Authentication
      block:
        - name: Get RH-SSO Admin Token to test authentication
          ansible.builtin.uri:
            url: "{{ rhsso_url }}/auth/realms/master/protocol/openid-connect/token"
            method: POST
            body_format: form-urlencoded
            body:
              username: "{{ keycloak_username }}"
              password: "{{ vault_keycloak_password }}"
              grant_type: password
              client_id: admin-cli
            validate_certs: false
            status_code: 200
          register: rhsso_auth_response
          no_log: true

        - name: Display Keycloak connection status
          ansible.builtin.debug:
            msg: "✅ SUCCESS: Successfully authenticated with Keycloak at '{{ rhsso_url }}'."
      rescue:
        - name: Display Keycloak connection failure
          ansible.builtin.fail:
            msg: "❌ FAILURE: Could not authenticate with Keycloak. Please check the URL and credentials in your variables file."

    - name: 3. Verify ServiceNow API Connection
      block:
        - name: Test ServiceNow instance connectivity
          ansible.builtin.uri:
            url: "{{ servicenow_url }}/api/now/table/sys_user?sysparm_limit=1"
            method: GET
            user: "{{ servicenow_username }}"
            password: "{{ vault_servicenow_password }}"
            force_basic_auth: yes
            headers:
              Accept: "application/json"
            validate_certs: false
            status_code: 200
          register: servicenow_connection_test
          no_log: true

        - name: Display ServiceNow connection status
          ansible.builtin.debug:
            msg: "✅ SUCCESS: Successfully connected to ServiceNow instance at '{{ servicenow_url }}'."
      rescue:
        - name: Display ServiceNow connection failure
          ansible.builtin.fail:
            msg: "❌ FAILURE: Could not connect to ServiceNow. Please check the URL and credentials in your variables file."
